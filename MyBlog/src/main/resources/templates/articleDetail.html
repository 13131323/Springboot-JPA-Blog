<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${article.title}">게시글 상세</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container mt-5">
    <article>
        <header class="mb-4">
            <h1 class="fw-bolder mb-1" th:text="${article.title}">제목</h1>
            <div class="text-muted fst-italic mb-2"
                 th:text="'작성일: ' + ${#temporals.format(article.createdAt, 'yyyy-MM-dd HH:mm')}">날짜</div>
            <div class="text-muted fst-italic mb-2" th:text="'작성자: ' + ${article.author}">작성자</div>
        </header>
        <section class="mb-5">
            <p class="fs-5 mb-4" th:text="${article.content}" style="white-space: pre-wrap;">내용</p>
        </section>
    </article>

    <div class="d-flex gap-2">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#updateModal">
            수정
        </button>
        <button type="button" id="delete-btn" class="btn btn-danger">삭제</button>
        <a href="/articles" class="btn btn-secondary">목록으로</a>
    </div>

    <hr class="my-5">

    <section class="mb-5">
        <div class="card bg-light">
            <div class="card-body">
                <h4 class="mb-4">댓글</h4>

                <div th:if="${#lists.isEmpty(comments)}" class="text-muted mb-3">
                    아직 댓글이 없습니다. 첫 댓글을 남겨보세요!
                </div>

                <div th:each="comment : ${comments}" class="d-flex mb-4">
                    <div class="ms-3 w-100">
                        <div class="d-flex justify-content-between">
                            <div class="fw-bold" th:text="${comment.author}">작성자</div>
                            <button type="button" class="btn btn-sm btn-outline-danger"
                                    th:onclick="|deleteComment(${comment.id})|">삭제</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                    th:data-id="${comment.id}"
                                    th:data-content="${comment.content}"
                                    onclick="openCommentModal(this)">수정</button>
                        </div>
                        <div th:text="${comment.content}">내용</div>
                        <small class="text-muted" th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}"></small>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="card my-4">
        <h5 class="card-header">댓글 남기기:</h5>
        <div class="card-body">
            <form>
                <div class="mb-3">
                    <input type="text" class="form-control" id="comment-author" placeholder="작성자">
                </div>
                <div class="mb-3">
                    <textarea class="form-control" id="comment-content" rows="3" placeholder="내용을 입력하세요"></textarea>
                </div>
                <button type="button" id="comment-create-btn" class="btn btn-primary">등록</button>
            </form>
        </div>
    </div>
</div>

<!-- modal : 수정 버튼 누르면 레이어드 되어 나오는 창 -->
<div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateModalLabel">게시글 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <input type="hidden" id="article-id" th:value="${article.id}">
                    <div class="mb-3">
                        <label for="modal-title" class="form-label">제목</label>
                        <input type="text" class="form-control" id="modal-title" th:value="${article.title}">
                    </div>
                    <div class="mb-3">
                        <label for="modal-content" class="form-label">내용</label>
                        <textarea class="form-control" id="modal-content" rows="10" th:text="${article.content}"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" id="update-btn" class="btn btn-primary">수정 완료</button>
            </div>
        </div>
    </div>
</div>

<!-- modal : 댓글 수정하면 나오는 레이어드 창 -->
<div class="modal fade" id="commentUpdateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">댓글 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modal-comment-id">
                <textarea class="form-control" id="modal-comment-content" rows="3"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" id="comment-update-btn" class="btn btn-primary">수정 완료</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // 1. 삭제 기능 (기존 코드 유지)
    const deleteButton = document.getElementById('delete-btn');
    if (deleteButton) {
        deleteButton.addEventListener('click', event => {
            let id = window.location.pathname.split('/').pop();
            fetch(`/api/articles/${id}`, { method: 'DELETE' })
                .then(() => {
                    alert('삭제가 완료되었습니다.');
                    location.replace('/articles');
                });
        });
    }

    // 2. 수정 기능 (새로 추가)
    const updateButton = document.getElementById('update-btn');
    if (updateButton) {
        updateButton.addEventListener('click', event => {
            let id = document.getElementById('article-id').value;

            fetch(`/api/articles/${id}`, {
                method: 'PUT',
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    title: document.getElementById('modal-title').value,
                    content: document.getElementById('modal-content').value
                })
            }).then(response => {
                if (response.ok) {
                    alert('수정이 완료되었습니다.');
                    location.reload(); // 페이지를 새로고침해서 수정된 내용 반영
                }
            });
        });
    }

    const commentCreateButton = document.getElementById('comment-create-btn');

    if (commentCreateButton) {
        commentCreateButton.addEventListener('click', event => {
            const articleId = window.location.pathname.split('/').pop();

            fetch(`/api/comments/${articleId}`, {
                method: 'POST',
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    author: document.getElementById('comment-author').value,
                    content: document.getElementById('comment-content').value
                })
            }).then(response => {
                if (response.ok) {
                    alert('댓글이 등록되었습니다.');
                    location.reload(); // 새로고침해서 새 댓글 확인
                }
            });
        });
    }

    function deleteComment(commentId) {
        if (!confirm("댓글을 삭제하시겠습니까?")) return;

        fetch(`/api/comments/${commentId}`, {
            method: 'DELETE'
        }).then(response => {
            if (response.ok) {
                alert('삭제가 완료되었습니다.');
                location.reload(); // 삭제 후 새로고침해서 목록 갱신
            } else {
                alert('삭제에 실패했습니다.');
            }
        });
    }

    function openCommentModal(button) {
        // 버튼에 심어둔 data- 속성 값을 꺼내옵니다.
        const id = button.getAttribute('data-id');
        const content = button.getAttribute('data-content');

        // 모달창 안의 입력칸에 값을 채웁니다.
        document.getElementById('modal-comment-id').value = id;
        document.getElementById('modal-comment-content').value = content;

        // 부트스트랩 모달 띄우기
        const modal = new bootstrap.Modal(document.getElementById('commentUpdateModal'));
        modal.show();
    }

    // 2. 실제 수정 요청을 보내는 로직
    const commentUpdateButton = document.getElementById('comment-update-btn');
    if (commentUpdateButton) {
        commentUpdateButton.addEventListener('click', event => {
            const id = document.getElementById('modal-comment-id').value;

            fetch(`/api/comments/${id}`, {
                method: 'PUT',
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    content: document.getElementById('modal-comment-content').value
                })
            }).then(response => {
                if (response.ok) {
                    alert('댓글이 수정되었습니다.');
                    location.reload();
                }
            });
        });
    }
</script>
</body>
</html>